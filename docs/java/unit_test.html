<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>[Java 开发实战] 高级工程师的自我修养之单元测试（一）：DAO 层测试 | lcomplete 的技术分享</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="分享Java、.NET、Javascript、效率、软件工程、编程语言等技术知识。">
    
    <link rel="preload" href="/assets/css/0.styles.d41f146a.css" as="style"><link rel="preload" href="/assets/js/app.9997d05c.js" as="script"><link rel="preload" href="/assets/js/3.93173371.js" as="script"><link rel="preload" href="/assets/js/4.8860c722.js" as="script"><link rel="preload" href="/assets/js/37.729c358d.js" as="script"><link rel="preload" href="/assets/js/21.ae6d6427.js" as="script"><link rel="prefetch" href="/assets/js/1.35b3d58c.js"><link rel="prefetch" href="/assets/js/10.de60410a.js"><link rel="prefetch" href="/assets/js/11.962a924e.js"><link rel="prefetch" href="/assets/js/12.c021125b.js"><link rel="prefetch" href="/assets/js/13.0edc9c50.js"><link rel="prefetch" href="/assets/js/14.59e1e9e5.js"><link rel="prefetch" href="/assets/js/15.bd79de23.js"><link rel="prefetch" href="/assets/js/16.e72f5255.js"><link rel="prefetch" href="/assets/js/17.e0141cee.js"><link rel="prefetch" href="/assets/js/18.15fe238d.js"><link rel="prefetch" href="/assets/js/19.ce865e29.js"><link rel="prefetch" href="/assets/js/20.826617c3.js"><link rel="prefetch" href="/assets/js/22.8f1e4394.js"><link rel="prefetch" href="/assets/js/23.f83af478.js"><link rel="prefetch" href="/assets/js/24.317d753f.js"><link rel="prefetch" href="/assets/js/25.3672f310.js"><link rel="prefetch" href="/assets/js/26.cac767d4.js"><link rel="prefetch" href="/assets/js/27.72dc2557.js"><link rel="prefetch" href="/assets/js/28.d7cc683e.js"><link rel="prefetch" href="/assets/js/29.13abd2c3.js"><link rel="prefetch" href="/assets/js/30.e43de048.js"><link rel="prefetch" href="/assets/js/31.ff990106.js"><link rel="prefetch" href="/assets/js/32.4846a58d.js"><link rel="prefetch" href="/assets/js/33.b972282e.js"><link rel="prefetch" href="/assets/js/34.93ad7e9a.js"><link rel="prefetch" href="/assets/js/35.5d7c671c.js"><link rel="prefetch" href="/assets/js/36.9f6a9011.js"><link rel="prefetch" href="/assets/js/38.c812c5aa.js"><link rel="prefetch" href="/assets/js/39.fee0e525.js"><link rel="prefetch" href="/assets/js/40.fea5e4bd.js"><link rel="prefetch" href="/assets/js/41.7d6a497d.js"><link rel="prefetch" href="/assets/js/42.64485ea5.js"><link rel="prefetch" href="/assets/js/43.a5859706.js"><link rel="prefetch" href="/assets/js/44.f67c9cc1.js"><link rel="prefetch" href="/assets/js/45.aa575402.js"><link rel="prefetch" href="/assets/js/46.13d50513.js"><link rel="prefetch" href="/assets/js/47.c044817f.js"><link rel="prefetch" href="/assets/js/48.15382382.js"><link rel="prefetch" href="/assets/js/49.bd35d6b1.js"><link rel="prefetch" href="/assets/js/5.94ab22f2.js"><link rel="prefetch" href="/assets/js/50.211cebf6.js"><link rel="prefetch" href="/assets/js/6.40eafba6.js"><link rel="prefetch" href="/assets/js/7.75bf756d.js"><link rel="prefetch" href="/assets/js/8.b7d6389e.js"><link rel="prefetch" href="/assets/js/9.7018cabc.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d41f146a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">lcomplete 的技术分享</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://codelc.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://twitter.com/lcomplete_wild" target="_blank" rel="noopener noreferrer" class="nav-link external">
  推特
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://www.getrevue.co/profile/lcomplete" target="_blank" rel="noopener noreferrer" class="nav-link external">
  订阅周刊
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/lcomplete/TechShare" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://codelc.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://twitter.com/lcomplete_wild" target="_blank" rel="noopener noreferrer" class="nav-link external">
  推特
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://www.getrevue.co/profile/lcomplete" target="_blank" rel="noopener noreferrer" class="nav-link external">
  订阅周刊
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/lcomplete/TechShare" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/summary/" class="sidebar-link">目录</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>野生架构师周刊</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/letter/012.html" class="sidebar-link">012 📸 Old But Good 、UNIX 艺术、互联网历史博物馆</a></li><li><a href="/docs/letter/011.html" class="sidebar-link">011 🖼 Browser = OS 、文章、工具、资源、文摘、言论</a></li><li><a href="/docs/letter/010.html" class="sidebar-link">010 🚀 Hacking The Mind / 拆掉思维里的墙、放飞想象、打破规则</a></li><li><a href="/docs/letter/009.html" class="sidebar-link">009 🌈 Newsletter Of Newsletters、海绵宝宝的智慧</a></li><li><a href="/docs/letter/008.html" class="sidebar-link">008 📚 Notion vs Obsidian、程序设计 vs 软件工程</a></li><li><a href="/docs/letter/007.html" class="sidebar-link">007 🍀 十年后重新使用 RSS 给我带来的巨变</a></li><li><a href="/docs/letter/006.html" class="sidebar-link">006 📒 与人保持联系的系统、用低代码应用设计产品原型、万能锤</a></li><li><a href="/docs/letter/005.html" class="sidebar-link">005 ⚙️ IFTTT 和 Zapier 使用对比、最好的效率系统、投入产出比最高的 3 件事</a></li><li><a href="/docs/letter/004.html" class="sidebar-link">004 🧛‍♂ 备受程序员喜爱的暗黑主题、程序员的英语有多重要、Newsletter 资源分享</a></li><li><a href="/docs/letter/003.html" class="sidebar-link">003 🐂 新一代 kubernetes、反脆弱</a></li><li><a href="/docs/letter/002.html" class="sidebar-link">002 🕷 Web 3.0、关于好品味的商业模式</a></li><li><a href="/docs/letter/001.html" class="sidebar-link">001 🐣 低代码、我的信息管理</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Java</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/java/俯瞰Java服务端开发.html" class="sidebar-link">俯瞰 Java 服务端开发</a></li><li><a href="/docs/java/part_one_of_java_engineer_path.html" class="sidebar-link">Java 工程师能力提升路径（一）：从业余到专业</a></li><li><a href="/docs/java/java_study_way.html" class="sidebar-link">Java 学习大法</a></li><li><a href="/docs/java/liquibase.html" class="sidebar-link">[Java 开发实战] 5 分钟搞定 liquibase 数据库版本控制</a></li><li><a href="/docs/java/unit_test.html" aria-current="page" class="active sidebar-link">[Java 开发实战] 高级工程师的自我修养之单元测试（一）：DAO 层测试</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/java/unit_test.html#开篇导读" class="sidebar-link">开篇导读</a></li><li class="sidebar-sub-header"><a href="/docs/java/unit_test.html#单元测试基本原则" class="sidebar-link">单元测试基本原则</a></li><li class="sidebar-sub-header"><a href="/docs/java/unit_test.html#dao-层单元测试" class="sidebar-link">DAO 层单元测试</a></li><li class="sidebar-sub-header"><a href="/docs/java/unit_test.html#写在最后" class="sidebar-link">写在最后</a></li></ul></li><li><a href="/docs/java/api_error_handling.html" class="sidebar-link">[Java 开发实战] 你还在统一返回 ApiResultBean 吗？✋ duck 不必，快来看 API 错误处理的最佳实践 ✔️</a></li><li><a href="/docs/java/spring_best_practice.html" class="sidebar-link">Java Spring 项目开发最佳实践</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>数据库</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/db/mysql_standard.html" class="sidebar-link">MySQL 数据库开发规范</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>软件工程</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/engineering/devops.html" class="sidebar-link">万字长文带你彻底搞懂什么是 DevOps</a></li><li><a href="/docs/engineering/gitflow.html" class="sidebar-link">网站项目 Git 使用流程和规范</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Javascript</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/js/remotion.html" class="sidebar-link">🎄 [React] 使用 remotion 制作视频，让圣诞快乐 PSD 动起来</a></li><li><a href="/docs/js/lit_layui.html" class="sidebar-link">使用 lit 编写 Web Components 简化 Layui 代码</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>编程人生</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/thinking/编码的道与禅.html" class="sidebar-link">编码的道与禅</a></li><li><a href="/docs/thinking/程序员的职业素养.html" class="sidebar-link">程序员的职业素养</a></li><li><a href="/docs/thinking/coder_kpi.html" class="sidebar-link">研发质量与效率的绩效指标设计</a></li><li><a href="/docs/thinking/quotes.html" class="sidebar-link">编程界的 51 条名言佳句</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>编程语言</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/lang/使用prolog解决爱因斯坦斑马难题.html" class="sidebar-link">使用prolog解决爱因斯坦斑马难题</a></li><li><a href="/docs/lang/一段简单的ruby爬虫代码.html" class="sidebar-link">一段简单的ruby爬虫代码</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>效率</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/10x/script.html" class="sidebar-link">[10 倍程序员] ⭐脚本的魅力，内含 js 写爬虫、python 骚操作等实用代码</a></li><li><a href="/docs/10x/terminal.html" class="sidebar-link">[10 倍程序员] ⭐51W+ 的终端命令行工具助你成为 10 倍程序员</a></li><li><a href="/docs/tools/我的效率工具箱.html" class="sidebar-link">效率工具箱</a></li><li><a href="/docs/tools/n8n.html" class="sidebar-link">使用开源工作流自动化工具 n8n 打造个人助理</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="java-开发实战-高级工程师的自我修养之单元测试-一-dao-层测试">[Java 开发实战] 高级工程师的自我修养之单元测试（一）：DAO 层测试</h1> <h2 id="开篇导读">开篇导读</h2> <p>对于程序员而言，单元测试是非常重要的一项技能，但在许多实际的项目开发过程中，单元测试却往往被忽略，这导致部分人也忽视其重要性，因此在开篇请允许笔者先唠叨几句关于它的重要性，若读者朋友对这部分内容已经了然于胸可直接前往 <code>DAO 层测试</code> 部分。</p> <p>关于编写单元测试的一些基础知识，我在这篇 <a href="https://github.com/lcomplete/TechShare/blob/master/docs/java/java%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95.pptx" target="_blank" rel="noopener noreferrer">Java 单元测试<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> PPT 中有过介绍，本系列文章不再赘述，而旨在讲解在企业级项目中该如何编写单元测试。</p> <p>这个系列计划编写三篇文章，DAO 层测试、业务逻辑层测试、高效编写测试。</p> <h3 id="为什么单元测试很重要">为什么单元测试很重要？</h3> <p>为什么说判断一个程序员是中级还是高级，看看 TA 会不会写单元测试就知道了，因为写单元测试不仅是写测试代码，往往还需要重新审视产品代码本身，必要的时候需要进行重构才能继续编写测试，在编写单元测试代码的过程中时刻都能体会到高内聚、低耦合的编程思想。写单元测试，其实是为对象模型添加了一个特殊用户，这个过程也迫使我们把对象模型设计的更加易用，总的说来编写单元测试可以加深对高内聚、低耦合、面向接口编程、依赖注入、API 设计、单一职责等<code>编程思想的掌握</code>，所以单元测试是如此重要，以至于可以很好地用来判断一个工程师的技术水平，或者至少用来判断其编程思想。</p> <h3 id="为什么单元测试难以实施">为什么单元测试难以实施?</h3> <p>很多小企业都难以实施单元测试，主要原因有：编写单元测试需要花费不少时间、单元测试并非想象中那样容易编写、开发人员对单元测试的理解不够全面等。还有一些更糟糕的情况，比如代码本身完成度不够，CRUD 功能背后缺少数据验证、服务端业务逻辑验证，系统本身就不堪一击，若要编写单元测试，需要做大量的代码改造工作，这种情况我愿称之为单元测试领域的「<code>戴维斯双杀</code>」效应——因为代码本身完成度低，原本完善的代码应当具有一定的复杂度，但在开发时却实现的极为简单，只满足了表面的功能，开发人员认为过于简单的代码没有编写单元测试的必要，导致产品代码质量下滑、对单元测试的理解扭曲的双重负循环。</p> <p>单元测试难以实施，总的可以归结为开发能力和产品质量文化的原因，对于想长期发展的企业来说，无疑是会注重这两个方面，因此大多数企业也在不断克服这些问题，提升工程师的能力，加强编写单元测试的质量和效率，同时还要树立正确的产品质量观念，要知道即使是付出了额外的编写单元测试的时间，总的时间成本也并不会增加，因为「<code>质量是免费的</code>」，产品质量提升了，用于排查问题、修复 bug 的时间自然变少了。</p> <p>在企业中注入产品质量文化，提升开发人员编写单元测试的能力，只要做到这些，实施单元测试也没有想象中困难。</p> <h2 id="单元测试基本原则">单元测试基本原则</h2> <p>首先要明确单元测试的一些基本原则，优秀的单元测试具有以下特点：</p> <ul><li>自动的、可重复的</li> <li>容易实现</li> <li>一旦写好，将来都可使用</li> <li>任何人都可运行</li> <li>单击一个按钮就可运行</li> <li>可以快速地运行</li></ul> <p>单元测试并非是随手写来验证功能的临时代码，而是需要符合 AIR 原则，所以编写起来是需要一定的功力的。</p> <p>关于 AIR 原则在阿里的 Java 规范中有提及，其他相关的规范也值得学习，我在这里引用方便读者朋友查看，完整的规范可在 Github 中查看，地址：<a href="https://github.com/alibaba/p3c/blob/master/p3c-gitbook/%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95.md" target="_blank" rel="noopener noreferrer">p3c 单元测试<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <ol><li>【强制】好的单元测试必须遵守AIR原则。
<br><span style="color:orange;">说明</span>：单元测试在线上运行时，感觉像空气（AIR）一样并不存在，但在测试质量的保障上，却是非常关键的。好的单元测试宏观上来说，具有自动化、独立性、可重复执行的特点。</li></ol> <ul><li>A：Automatic（自动化）</li> <li>I：Independent（独立性）</li> <li>R：Repeatable（可重复）</li></ul> <ol start="2"><li>【强制】单元测试应该是全自动执行的，并且非交互式的。测试用例通常是被定期执行的，执行过程必须完全自动化才有意义。输出结果需要人工检查的测试不是一个好的单元测试。单元测试中不准使用System.out来进行人肉验证，必须使用assert来验证。</li> <li>【强制】保持单元测试的独立性。为了保证单元测试稳定可靠且便于维护，单元测试用例之间决不能互相调用，也不能依赖执行的先后次序。 <br><span style="color:red;">反例</span>：method2需要依赖method1的执行，将执行结果作为method2的输入。</li> <li>【强制】单元测试是可以重复执行的，不能受到外界环境的影响。
<br><span style="color:orange;">说明</span>：单元测试通常会被放到持续集成中，每次有代码check in时单元测试都会被执行。如果单测对外部环境（网络、服务、中间件等）有依赖，容易导致持续集成机制的不可用。 <br><span style="color:green;">正例</span>：为了不受外界环境影响，要求设计代码时就把SUT的依赖改成注入，在测试时用spring 这样的DI框架注入一个本地（内存）实现或者Mock实现。</li> <li>【强制】对于单元测试，要保证测试粒度足够小，有助于精确定位问题。单测粒度至多是类级别，一般是方法级别。
<br><span style="color:orange;">说明</span>：只有测试粒度小才能在出错时尽快定位到出错位置。单测不负责检查跨类或者跨系统的交互逻辑，那是集成测试的领域。</li> <li>【强制】核心业务、核心应用、核心模块的增量代码确保单元测试通过。
<br><span style="color:orange;">说明</span>：新增代码及时补充单元测试，如果新增代码影响了原有单元测试，请及时修正。</li></ol> <p>明确这些基本规范后，我们来开始动手编写单元测试。</p> <p>完善的单元测试，应该对项目的每一层级代码都进行测试，本篇文章我们从 DAO 层开始。</p> <h2 id="dao-层单元测试">DAO 层单元测试</h2> <p>DAO 层由于依赖数据库，是比较难以测试的，这个章节将为你提供一些 DAO 层的测试方法。</p> <p>以 MySQL 数据库为例，在运行 DAO 层的单元测试时，我们不能依赖外部的数据库，因为这会破坏 AIR 原则中的 I（独立性） 原则，要解除依赖有几种方式：</p> <ol><li>使用嵌入式数据库：h2、moby 等。</li> <li>使用 Testcontainers 在 docker 中创建专为单元测试使用的数据库，执行完即销毁。</li></ol> <h3 id="使用嵌入式数据库">使用嵌入式数据库</h3> <p>我们先看第一种方式，以 h2 为例。</p> <p>首先，在单元测试的应用配置 <code>application.yml</code> 中修改数据源为 h2。</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
    <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> org.h2.Driver
    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>h2<span class="token punctuation">:</span>mem<span class="token punctuation">:</span>ufo
</code></pre></div><p>如果我们使用的是 JPA 进行数据持久化，配置这些即可，JPA 会在 h2 数据库中自动创建数据库。</p> <p>若使用的是 MyBatis，则需要指定数据库的架构，增加以下配置，<code>data</code> 为数据初始化脚本。</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
    <span class="token key atrule">schema</span><span class="token punctuation">:</span> classpath<span class="token punctuation">:</span>db/schema<span class="token punctuation">-</span>h2.sql
    <span class="token key atrule">data</span><span class="token punctuation">:</span> classpath<span class="token punctuation">:</span>db/data<span class="token punctuation">-</span>h2.sql
</code></pre></div><p>假如我们的项目非常小，用这种方式就足够，但当数据库 <code>schema</code> 越来越庞大时，维护 sql 将变成一项耗时的工作，那么我们需要引入数据库的版本控制机制。</p> <h3 id="数据库版本控制">数据库版本控制</h3> <p>数据库版本控制可以使用 <code>flyway</code> 或者 <code>liquibase</code>，关于 liquibase 的用法，可以参考我写的 <a href="https://lcomplete.github.io/TechShare/docs/java/liquibase.html" target="_blank" rel="noopener noreferrer">5 分钟搞定 liquibase 数据库版本控制<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 。</p> <p>以 liquibase 为例，引入后，我们在 <code>application.yml</code> 进行如下类似修改，单元测试运行时将首先通过 liquibase 初始化数据库。</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">liquibase</span><span class="token punctuation">:</span>
    <span class="token key atrule">change-log</span><span class="token punctuation">:</span> classpath<span class="token punctuation">:</span>liquibase/master.xml
    <span class="token key atrule">contexts</span><span class="token punctuation">:</span> unit_test
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre></div><p>注意，此时我们编写的版本控制 sql 是为 MySQL 数据库准备的，若直接用于 h2 数据库，大概率会出现兼容性问题，此时我们有以下几个选择：</p> <ol><li>将用于 MySQL 的 sql 脚本稍作修改，用于 h2 数据库初始化。</li> <li>使用 liquibase 的 xml 语法来定义数据库结构，减少兼容性问题。</li> <li>改用 <code>Testcontainers</code> 辅助测试。</li></ol> <p>前面两个选择，都需要增加不小的工作量，我们来看看使用 Testcontainers 会如何。</p> <h3 id="使用-testcontainers">使用 Testcontainers</h3> <p><a href="https://github.com/testcontainers/testcontainers-java" target="_blank" rel="noopener noreferrer">Testcontainers<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>  是一个支持 <code>JUnit</code> 测试的开源库，可以利用 <code>Docker</code> 容器获得 <code>即用即丢</code> 数据库的能力。</p> <p>我们跳过了别的选项，直接选择 Testcontainers，因为使用嵌入式数据库还有一些缺点，比如 DAO 层使用了特定数据库才有的语法，那么单元测试根本都无法通过，这在企业级项目中几乎是无法避免的，除非是特别独立单一的服务。</p> <p>DAO 层单元测试不应该依赖外部数据库，但在执行时也应当使用类生产的环境，这样的测试结果才更准确的。</p> <p>使用 Testcontainers 并 <code>不符合 AIR 原则</code>，因为其依赖了 Docker 环境，如果在一台没有 Docker 环境的机器上运行，那么测试就会失败，另外它也不符合可以快速地运行这一点，毕竟初始化 Docker 容器是需要一定的时间的。</p> <p>我们看下如何在代码中使用 Testcontainers 。</p> <p>首先定义一个抽象的测试基类，具体的单元测试继承自该类，以下写法可以确保数据库只初始化一次。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootTest</span>
<span class="token annotation punctuation">@ContextConfiguration</span><span class="token punctuation">(</span>initializers <span class="token operator">=</span> <span class="token class-name">AbstractUnitTest<span class="token punctuation">.</span>DockerMySQLDataSourceInitializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractUnitTest</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">MySQLContainer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> mysql<span class="token punctuation">;</span>
    
    <span class="token keyword">static</span> <span class="token punctuation">{</span>
       mysql <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MySQLContainer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;mysql:8.0.11&quot;</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">withDatabaseName</span><span class="token punctuation">(</span><span class="token string">&quot;dbname&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       mysql<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">DockerMySQLDataSourceInitializer</span> <span class="token keyword">implements</span> <span class="token class-name">ApplicationContextInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigurableApplicationContext</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NotNull</span> <span class="token class-name">ConfigurableApplicationContext</span> applicationContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">TestPropertySourceUtils</span><span class="token punctuation">.</span><span class="token function">addInlinedPropertiesToEnvironment</span><span class="token punctuation">(</span>
                   applicationContext<span class="token punctuation">,</span>
                   <span class="token string">&quot;spring.datasource.url=&quot;</span> <span class="token operator">+</span> mysql<span class="token punctuation">.</span><span class="token function">getJdbcUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                   <span class="token string">&quot;spring.datasource.username=&quot;</span> <span class="token operator">+</span> mysql<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                   <span class="token string">&quot;spring.datasource.password=&quot;</span> <span class="token operator">+</span> mysql<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                   <span class="token string">&quot;spring.datasource.driver-class-name=&quot;</span> <span class="token operator">+</span> mysql<span class="token punctuation">.</span><span class="token function">getDriverClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>准备就绪后，在单元测试执行时将首先创建 Docker 容器，然后运行 liquibase 初始化数据库。</p> <p>来看一个简单的 DAO 层测试的例子。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootTest</span>
<span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@TestInstance</span><span class="token punctuation">(</span><span class="token class-name">TestInstance<span class="token punctuation">.</span>Lifecycle</span><span class="token punctuation">.</span>PER_CLASS<span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">NavSiteRepositoryTest</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractUnitTest</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">NavSiteRepository</span> navSiteRepository<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@BeforeClass</span>
    <span class="token keyword">void</span> <span class="token function">setUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">NavSite</span> navSite <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NavSite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        navSite<span class="token punctuation">.</span><span class="token function">setSiteName</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        navSite<span class="token punctuation">.</span><span class="token function">setSiteUrl</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        navSite<span class="token punctuation">.</span><span class="token function">setIconPath</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        navSite<span class="token punctuation">.</span><span class="token function">setSiteType</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        navSite<span class="token punctuation">.</span><span class="token function">setSort</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        navSite<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        navSite<span class="token punctuation">.</span><span class="token function">setUpdateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        navSiteRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>navSite<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">findBySiteType_UnknownSiteType_ZeroSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">NavSite</span><span class="token punctuation">&gt;</span></span> navSites <span class="token operator">=</span> navSiteRepository<span class="token punctuation">.</span><span class="token function">findBySiteType</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertThat</span><span class="token punctuation">(</span>navSites<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqualTo</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">findBySiteType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">NavSite</span><span class="token punctuation">&gt;</span></span> navSites <span class="token operator">=</span> navSiteRepository<span class="token punctuation">.</span><span class="token function">findBySiteType</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertThat</span><span class="token punctuation">(</span>navSites<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqualTo</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>至此，我们就实现了 <code>JUnit5 + Testcontainers + Liquibase</code> 进行 DAO 层测试。</p> <h3 id="方案取舍">方案取舍</h3> <p>应该在使用嵌入式数据库、Docker和专用测试数据库之间进行取舍，目前的持续集成环境中基本都有 Docker 环境，相信 Testcontainers 也会越来越流行，就算不用在单元测试中，在 <code>集成测试</code> 中进行使用也是非常有用的一大利器。</p> <p>总结如下：</p> <ol><li>在简单的项目中使用 h2 或其他嵌入式数据库进行 DAO 层测试。</li> <li>在特定的场景下选择 Testcontainers，可以设法令其符合 AIR 原则并能快速运行，比如在 liquibase 项目中用于测试版本控制 sql 就是个不错的选择。</li> <li>集成测试中可尽管选用 Testcontainers 。</li></ol> <h2 id="写在最后">写在最后</h2> <p>DAO 层的测试难点主要在解除数据库这一外部依赖上，DAO 层的业务逻辑代码较少，因此单元测试编写起来也比较简单，而复杂的 Service 层代码则不一样，容易出现单元测试难以编写的情况，这时需要优化代码设计，这部分内容我们在下一篇 <code>业务逻辑层测试</code> 中详述。</p></div> <footer class="page-edit"><!----> <div class="git-hub-star"><span class="prefix"><span style="position:relative;top:4px;right:-4px;"><a href="https://github.com/lcomplete/TechShare" aria-label="Star lcomplete/TechShare on GitHub" data-icon="octicon-star" data-show-count="true">
      Star
    </a></span></span></div> <div class="last-updated"><span class="prefix">总字数:</span> <span class="words">3,457</span> <span class="prefix">字　</span> <span class="prefix">最后更新:</span> <span class="time">12/10/2021, 7:20:58 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
    ←
    <a href="/docs/java/liquibase.html" class="prev">
      [Java 开发实战] 5 分钟搞定 liquibase 数据库版本控制
    </a></span> <span class="next"><a href="/docs/java/api_error_handling.html">
      [Java 开发实战] 你还在统一返回 ApiResultBean 吗？✋ duck 不必，快来看 API 错误处理的最佳实践 
    </a>
    →
  </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.9997d05c.js" defer></script><script src="/assets/js/3.93173371.js" defer></script><script src="/assets/js/4.8860c722.js" defer></script><script src="/assets/js/37.729c358d.js" defer></script><script src="/assets/js/21.ae6d6427.js" defer></script>
  </body>
</html>
